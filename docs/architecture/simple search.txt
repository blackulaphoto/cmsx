### ğŸ”‘ Goal

Ship a **bullet-proof, dead-simple search layer** that never drags the whole platform down. It must:

1. **Unify** Jobs | Housing | Services | General Web search behind ONE coordinator.
2. **Default to robust APIs** (Google Custom Search, official job boards, Places APIs).
3. **Sandbox any scraping** behind async â€œadapterâ€ workers so a bad site canâ€™t crash the app.
4. **Return one standard result schema** so every downstream module (UI, AI, Reminders) speaks the same language.
5. **Fail gracefully**â€”cached data or local DB samples if live calls error out.

---

## ğŸ§­  High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   query   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Front End  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ /api/search/...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  Search Gateway  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ SearchCoordinator    â”‚
                         â”‚  (core Python svc)   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      type=jobs                  type=housing               fallback
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JobsAdapter  â”‚         â”‚ HousingAdapter   â”‚        â”‚ WebAdapter     â”‚
â”‚ ğŸ”—  Google CS â”‚         â”‚ ğŸ”—  Google CS    â”‚        â”‚ ğŸ”— Google CS   â”‚
â”‚ ğŸ”—  Adzuna APIâ”‚         â”‚ ğŸ”—  HUD APIs     â”‚        â”‚ (generic)      â”‚
â”‚ ğŸ’¤ Craigslist â”‚         â”‚ ğŸ’¤ Shelter scrpr â”‚        â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                             â–²                      â–²
         â”‚ async task queue (Celery/RQ â”‚          same queue  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Redis/DB Cache & Error-safe fallbackâ”˜
```

* **SearchGateway**: Thin FastAPI router. Parses params (`type`, `query`, `location`, flags) and hands off to the coordinator.
* **SearchCoordinator**: Pure Python service that enforces query enhancement (GPT-4 prompt or basic string ops), picks the right adapter, de-dupes results, standardizes schema, writes to Redis cache, and returns JSON.
* **Adapters**: One per domain.

  * **Tier-1 = API** (Google Custom Search, official REST feeds).
  * **Tier-2 = Scraper** wrapped in Celery/RQ so a timeout or CAPTCHA never blocks the request path.
  * **Tier-3 = Local DB** snapshot for offline/demo.
* **Unified Schema** (examples):

```json
{
  "id": "jobs_123",
  "type": "job",           // job | housing | service | web
  "name": "Warehouse Team Member",
  "provider": "Target",
  "description": "...",
  "location": "Los Angeles, CA",
  "phone": "(555) 123-4567",
  "url": "https://careers.target.com/...",
  "tags": ["background-friendly", "full-time"],
  "source": "google_cse",
  "retrieved_at": "2025-08-04T13:45:00-07:00"
}
```

Down-stream code (AI assistant, UI chips, Reminders â€œApplyâ€ flow) can rely on this structure no matter who produced it.

---

## ğŸš¦  Step-by-Step Build Order (search subsystem only)

| Phase  | Deliverable                                  | Key Decisions & Safeguards                                                                                                                                                        |
| ------ | -------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **S0** | **Skeleton Gateway + Coordinator**           | Set up `/api/search` route. Return hard-coded sample JSON so UI can integrate immediately.                                                                                        |
| **S1** | **Google Custom Search Adapter (all types)** | *No scraping yet.* Use env-vars for keys. Implement basic `cache.get_or_set(query+type)` to avoid quota spikes.                                                                   |
| **S2** | **Jobs Tier-1 APIs**                         | Plug Adzuna or Rapid â€œJobsâ€ APIs (free tier) before touching Craigslist. Parse â†’ unified schema.                                                                                  |
| **S3** | **Services Tier-1 APIs**                     | Use Google Places / Healthcare.gov / OpenReferral feeds.                                                                                                                          |
| **S4** | **Housing Tier-1 APIs**                      | HUD Exchange, HUDUser, or public county feeds. Store results nightly into `housing_resources` table as fallback.                                                                  |
| **S5** | **Async Scraper Adapters (optional)**        | Wrap Craigslist, CityJobs, ZocDoc, etc., in Celery workers â†’ queue. Coordinator requests them **only** if Tier-1 returns < N results **and** feature flag `allow_scrapers=True`.  |
| **S6** | **AI Query Enhancement**                     | Plug GPT-4 function to rewrite queries (adds â€œsecond chanceâ€, â€œbackground friendlyâ€, zip code). 60-token max. Fallback to naÃ¯ve concat if model error.                            |
| **S7** | **Edge-case Hardening**                      | â€¢ 3-strike circuit breaker for any adapter that throws > 3 errors in 10 min.  \nâ€¢ Metrics endpoint `/api/search/health` with last success counts, average latency.                |
| **S8** | **Integration Hooks**                        | When a case-manager clicks â€œSave to Clientâ€ from search results, create `resource_link` record **and** schedule a follow-up Task via Reminders (e.g., â€œCall landlord in 3 daysâ€). |

---

## ğŸ› ï¸  Implementation Notes & Best Practices

1. **Single Search Module** in repo (`/search/`). Adapters live in `/search/adapters/`.
2. **Strict Dependencies**:

   * Coordinator imports adapters **via interfaces**, not concrete classes â‡’ new adapter â‰  code-base refactor.
   * Adapters cannot import each other.
3. **Async Queue (Celery + Redis)** for scraping so FastAPI thread pool stays clean. If queue task exceeds 20 s, coordinator returns API results and drops scraper promise.
4. **Caching & Rate Limits**:

   * Key: `sha1(query|type|location)` â‡’ JSON payload, TTL 12 h.
   * If Google quota hit, coordinator returns cache or DB fallback.
5. **Environment-Driven Config**: `SEARCH_ALLOW_SCRAPERS`, `GOOGLE_API_KEY`, etc. â€” one `.env` entry point.
6. **Result Scoring**: Add simple heuristics early (exact keyword match, â€œbackground friendlyâ€ tokens), then let GPT-4 rank later if needed.
7. **Unit & Load Tests**: Mock Google API responses; test coordinator logic; simulate 100 parallel search calls to ensure no deadlocks.
8. **Observability**: instrument with `structlog` + Prometheus metrics: `search_latency_seconds`, `search_errors_total{adapter="google_cse"}`.

---

### What This Fixes From the Old Build

| Old Pain                               | New Approach                                                         |
| -------------------------------------- | -------------------------------------------------------------------- |
| Scraper choke blocked request thread   | **Async adapters**; Tier-1 API completes even if scraper fails       |
| Multiple modules re-implemented search | **One Coordinator**; single schema; no code duplication              |
| Housing search lagged behind           | Housing uses **same infra** as jobs/services; add HUD feed day-one   |
| API quota bombs entire feature         | Redis cache + fallback DB sample; circuit breaker on repeated errors |
| Hard-coded site lists                  | Pluggable adapters; can disable or add via feature flags             |

---

## ğŸ”œ  Immediate Next Tasks

1. **Spin up `/search` directory with Coordinator class + GoogleCSEAdapter (Phase S1).**
2. **Add `.env.example` with required keys & flags.**
3. **Create FastAPI route** `/api/search` accepting params: `type`, `q`, `location`, `background_friendly`. Return sample data.
4. **Wire UI search bar** to call this endpoint (can still show dummy data).
5. **Write Celery config + one dummy adapter** (simulated 5-sec sleep) to prove async hand-off.

Once these are green, we can iterate through phases S2-S8 confidentlyâ€”without ever letting search instability poison the rest of the platform.
