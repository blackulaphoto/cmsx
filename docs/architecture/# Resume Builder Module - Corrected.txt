# Resume Builder Module - Corrected Technical Specification
## **Aligned with 9-Database Architecture**

## Module Overview

**Purpose**: AI-powered resume creation system optimized for formerly incarcerated individuals and second-chance employment opportunities.

**Core Integration**: Works seamlessly within the 9-database architecture, reading clients from `core_clients.db` and storing all employment data in `employment.db`.

---

## Database Architecture & Schema

### **Primary Database: employment.db**
**Owner**: Employment/Resume Module  
**Accesses**: core_clients.db (read-only for client selection)

```sql
-- CLIENT EMPLOYMENT PROFILES (Enhanced for Resume Builder)
client_employment_profiles (
    profile_id TEXT PRIMARY KEY,
    client_id TEXT NOT NULL,  -- FK to core_clients.clients
    work_history TEXT,        -- JSON array of employment records
    skills TEXT,              -- JSON array of skills by category
    education TEXT,           -- JSON array of education records
    certifications TEXT,      -- JSON array of certifications
    references TEXT,          -- JSON array of professional references
    career_objective TEXT,    -- Professional summary/objective
    preferred_industries TEXT, -- JSON array
    background_friendly_only BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- RESUMES (Core Resume Storage)
resumes (
    resume_id TEXT PRIMARY KEY,
    client_id TEXT NOT NULL,  -- FK to core_clients.clients
    profile_id TEXT,          -- FK to client_employment_profiles
    template_type TEXT CHECK (template_type IN ('classic', 'modern', 'warehouse', 'construction', 'food_service', 'medical_social')),
    resume_title TEXT,
    content TEXT,             -- JSON formatted final resume data
    pdf_path TEXT,            -- File system path to generated PDF
    ats_score INTEGER CHECK (ats_score BETWEEN 0 AND 100),
    is_active BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (client_id) REFERENCES core_clients.clients(client_id),
    FOREIGN KEY (profile_id) REFERENCES client_employment_profiles(profile_id)
);

-- JOB APPLICATIONS (Integrated Resume-to-Job Linking)
job_applications (
    application_id TEXT PRIMARY KEY,
    client_id TEXT NOT NULL,  -- FK to core_clients.clients
    resume_id TEXT,           -- FK to resumes table
    job_title TEXT,
    company_name TEXT,
    job_description TEXT,
    application_status TEXT CHECK (application_status IN ('draft', 'submitted', 'under_review', 'interview', 'rejected', 'offered')),
    applied_date DATE,
    follow_up_date DATE,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (client_id) REFERENCES core_clients.clients(client_id),
    FOREIGN KEY (resume_id) REFERENCES resumes(resume_id)
);

-- RESUME TAILORING HISTORY (Track AI Optimizations)
resume_tailoring (
    tailoring_id TEXT PRIMARY KEY,
    resume_id TEXT NOT NULL,  -- FK to resumes
    job_application_id TEXT,  -- FK to job_applications (optional)
    original_content TEXT,    -- JSON of original resume
    tailored_content TEXT,    -- JSON of AI-optimized content
    optimization_type TEXT,   -- 'ats_optimization', 'job_specific', 'industry_focus'
    match_score DECIMAL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (resume_id) REFERENCES resumes(resume_id),
    FOREIGN KEY (job_application_id) REFERENCES job_applications(application_id)
);
```

### **Secondary Database Access: core_clients.db**
**Read-Only Access for Client Selection**

```sql
-- ACCESSED (NOT OWNED) - Client Information
clients (
    client_id TEXT PRIMARY KEY,
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    phone TEXT,
    email TEXT,
    address TEXT,
    -- ... other client fields
);
```

---

## API Endpoints & Data Contracts

### **Client Integration**

#### 1. Get Available Clients
```http
GET /api/resume/clients

Response:
{
  "success": true,
  "clients": [
    {
      "client_id": "uuid",
      "first_name": "string",
      "last_name": "string",
      "phone": "string",
      "email": "string",
      "has_resume": boolean,
      "active_resumes": integer
    }
  ]
}
```

### **Employment Profile Management**

#### 2. Create/Update Employment Profile
```http
POST /api/resume/profile
Content-Type: application/json

{
  "client_id": "uuid",
  "work_history": [
    {
      "job_title": "string",
      "company": "string",
      "start_date": "YYYY-MM",
      "end_date": "YYYY-MM",
      "description": "string",
      "achievements": ["string"],
      "reason_for_leaving": "string"
    }
  ],
  "education": [
    {
      "degree": "string",
      "institution": "string",
      "graduation_date": "YYYY",
      "gpa": "decimal",
      "relevant_coursework": ["string"]
    }
  ],
  "skills": [
    {
      "category": "Technical Skills",
      "skill_list": ["string"]
    },
    {
      "category": "Soft Skills", 
      "skill_list": ["string"]
    }
  ],
  "certifications": [
    {
      "name": "string",
      "issuer": "string",
      "date_obtained": "YYYY-MM",
      "expiration_date": "YYYY-MM"
    }
  ],
  "career_objective": "string",
  "preferred_industries": ["string"]
}

Response:
{
  "success": true,
  "profile_id": "uuid",
  "message": "Employment profile saved successfully"
}
```

#### 3. Get Employment Profile
```http
GET /api/resume/profile/{client_id}

Response:
{
  "success": true,
  "profile": {
    "profile_id": "uuid",
    "client_id": "uuid",
    "work_history": [...],
    "education": [...],
    "skills": [...],
    "certifications": [...],
    "career_objective": "string",
    "preferred_industries": [...]
  }
}
```

### **Resume Management**

#### 4. Create Resume from Profile
```http
POST /api/resume/create
Content-Type: application/json

{
  "client_id": "uuid",
  "profile_id": "uuid", 
  "template_type": "modern",
  "resume_title": "string"
}

Response:
{
  "success": true,
  "resume_id": "uuid",
  "ats_score": 85,
  "pdf_generated": true,
  "pdf_url": "/api/resume/download/uuid"
}
```

#### 5. Get Client Resumes
```http
GET /api/resume/list/{client_id}

Response:
{
  "success": true,
  "resumes": [
    {
      "resume_id": "uuid",
      "resume_title": "string",
      "template_type": "modern",
      "ats_score": 85,
      "created_at": "ISO datetime",
      "is_active": true,
      "job_applications_count": 3
    }
  ]
}
```

#### 6. AI Resume Optimization
```http
POST /api/resume/optimize
Content-Type: application/json

{
  "resume_id": "uuid",
  "optimization_type": "ats_optimization", // or "job_specific", "industry_focus"
  "job_description": "string" // optional for job-specific optimization
}

Response:
{
  "success": true,
  "optimized_content": {
    "career_objective": "string",
    "highlighted_skills": ["string"],
    "work_experience_improvements": ["string"],
    "keyword_additions": ["string"]
  },
  "ats_score_improvement": 12,
  "new_ats_score": 92
}
```

### **PDF Generation**

#### 7. Generate PDF
```http
POST /api/resume/generate-pdf/{resume_id}

Response:
{
  "success": true,
  "pdf_path": "/static/resumes/resume_uuid.pdf",
  "download_url": "/api/resume/download/uuid"
}
```

#### 8. Download PDF
```http
GET /api/resume/download/{resume_id}
Content-Type: application/pdf
Content-Disposition: attachment; filename="resume_{client_name}.pdf"
```

### **Job Application Integration**

#### 9. Apply to Job with Resume
```http
POST /api/resume/apply-job
Content-Type: application/json

{
  "client_id": "uuid",
  "resume_id": "uuid",
  "job_title": "string",
  "company_name": "string",
  "job_description": "string"
}

Response:
{
  "success": true,
  "application_id": "uuid",
  "tailored_resume_created": true,
  "match_score": 89.5
}
```

#### 10. Get Job Applications for Client
```http
GET /api/resume/applications/{client_id}

Response:
{
  "success": true,
  "applications": [
    {
      "application_id": "uuid",
      "job_title": "string",
      "company_name": "string", 
      "application_status": "submitted",
      "applied_date": "YYYY-MM-DD",
      "resume_used": "uuid",
      "match_score": 89.5
    }
  ]
}
```

---

## Frontend Architecture

### **Component Hierarchy**
```
Resume.jsx (Main Route Container)
├── ClientSelector.jsx (Select from core_clients.db)
├── ProfileBuilder.jsx (Employment profile creation)
│   ├── WorkHistoryForm.jsx
│   ├── EducationForm.jsx  
│   ├── SkillsForm.jsx
│   └── CertificationsForm.jsx
├── ResumeCreator.jsx (Resume from profile)
│   ├── TemplateSelector.jsx
│   ├── ResumePreview.jsx
│   └── AIOptimizer.jsx
├── ResumeManager.jsx (List existing resumes)
├── JobApplication.jsx (Apply to jobs)
└── ApplicationTracker.jsx (Track applications)
```

### **React Query Integration**
```javascript
// Employment Profile Queries
const profileQueries = {
  client: (clientId) => ['employment-profile', clientId],
  create: ['employment-profile', 'create'],
  update: (profileId) => ['employment-profile', 'update', profileId]
};

// Resume Queries  
const resumeQueries = {
  list: (clientId) => ['resumes', 'client', clientId],
  detail: (resumeId) => ['resumes', 'detail', resumeId],
  create: ['resumes', 'create'],
  optimize: (resumeId) => ['resumes', 'optimize', resumeId]
};

// Job Application Queries
const applicationQueries = {
  client: (clientId) => ['job-applications', 'client', clientId],
  create: ['job-applications', 'create'],
  status: (applicationId) => ['job-applications', 'status', applicationId]
};
```

### **User Flow Sequences**

#### **1. First-Time Resume Creation**
```
1. ClientSelector.jsx → Select client from core_clients.db
2. Check if employment profile exists
3. If no profile: ProfileBuilder.jsx → Create employment profile
4. If profile exists: ResumeCreator.jsx → Create resume from profile
5. TemplateSelector.jsx → Choose template
6. ResumePreview.jsx → Preview and adjust
7. Generate PDF and save to employment.db
```

#### **2. Job Application with Resume**
```
1. ResumeManager.jsx → Select existing resume
2. JobApplication.jsx → Enter job details
3. AI optimization based on job description
4. Create job_applications record
5. Generate tailored PDF if needed
6. ApplicationTracker.jsx → Track application status
```

---

## AI Integration & Algorithms

### **ATS Scoring Algorithm**
```python
def calculate_ats_score(resume_content):
    """
    Calculate ATS compatibility score for employment.db storage
    """
    score_components = {
        'contact_info_complete': 15,     # Phone, email, address
        'keyword_optimization': 25,      # Industry keywords
        'format_compliance': 20,         # ATS-readable structure
        'section_organization': 15,      # Proper section order
        'quantified_achievements': 15,   # Numbers and metrics
        'skills_section_quality': 10     # Skills relevance
    }
    
    total_score = 0
    for component, weight in score_components.items():
        component_score = evaluate_component(resume_content, component)
        total_score += (component_score * weight) / 100
    
    return min(100, max(0, total_score))

async def save_ats_score(resume_id, score):
    """Update ATS score in employment.db"""
    await update_resume(resume_id, {'ats_score': score})
```

### **Resume Optimization**
```python
async def optimize_resume_for_job(resume_id, job_description):
    """
    AI-powered resume optimization stored in employment.db
    """
    # Get resume from employment.db
    resume = await get_resume_by_id(resume_id)
    original_content = json.loads(resume.content)
    
    # AI optimization prompt
    optimization_prompt = f"""
    Optimize this resume for the following job:
    
    Job Description: {job_description}
    Current Resume: {json.dumps(original_content)}
    
    Focus on:
    1. Keyword alignment with job requirements
    2. Highlighting relevant experience
    3. Emphasizing transferable skills
    4. Professional language for second-chance employment
    
    Return optimized sections with specific improvements.
    """
    
    # Get AI recommendations
    ai_response = await openai_chat_completion(optimization_prompt)
    optimized_content = parse_ai_optimization(ai_response)
    
    # Save tailoring record to employment.db
    tailoring_record = {
        'resume_id': resume_id,
        'original_content': original_content,
        'tailored_content': optimized_content,
        'optimization_type': 'job_specific',
        'match_score': calculate_job_match_score(optimized_content, job_description)
    }
    
    await save_resume_tailoring(tailoring_record)
    return optimized_content
```

---

## Cross-Module Integration

### **1. Core Clients Integration**
```python
async def get_available_clients():
    """
    Read client list from core_clients.db for Resume Builder
    """
    clients_query = """
    SELECT 
        c.client_id,
        c.first_name,
        c.last_name,
        c.phone,
        c.email,
        CASE WHEN r.client_id IS NOT NULL THEN 1 ELSE 0 END as has_resume,
        COUNT(r.resume_id) as active_resumes
    FROM core_clients.clients c
    LEFT JOIN employment.resumes r ON c.client_id = r.client_id AND r.is_active = 1
    WHERE c.case_status = 'active'
    GROUP BY c.client_id
    """
    return await execute_cross_db_query(clients_query)

async def populate_client_info(client_id):
    """
    Auto-populate resume with client data from core_clients.db
    """
    client = await get_client_from_core_db(client_id)
    return {
        'personal_info': {
            'first_name': client.first_name,
            'last_name': client.last_name,
            'phone': client.phone,
            'email': client.email,
            'address': client.address
        }
    }
```

### **2. Reminders Integration**
```python
async def create_resume_reminders(client_id, resume_id):
    """
    Create follow-up reminders in reminders.db
    """
    reminders = [
        {
            'client_id': client_id,
            'module_source': 'employment',
            'task_type': 'resume_follow_up',
            'description': f'Follow up on resume applications',
            'due_date': datetime.now() + timedelta(days=7),
            'priority_score': 60
        }
    ]
    
    for reminder in reminders:
        await create_reminder(reminder)
```

### **3. AI Assistant Integration**
```python
async def get_employment_context_for_ai(client_id):
    """
    Provide employment data to AI Assistant from employment.db
    """
    employment_data = await get_client_employment_data(client_id)
    return {
        'resumes_count': len(employment_data.resumes),
        'active_applications': len([app for app in employment_data.applications if app.status in ['submitted', 'under_review']]),
        'employment_goals': employment_data.profile.career_objective,
        'skills_summary': employment_data.profile.skills,
        'recent_activity': employment_data.recent_resume_updates
    }
```

---

## File System & PDF Generation

### **PDF Storage Structure**
```
/static/resumes/
├── client_{client_id}/
│   ├── resume_{resume_id}.pdf
│   ├── tailored_{resume_id}_{job_id}.pdf
│   └── versions/
│       ├── resume_{resume_id}_v1.pdf
│       └── resume_{resume_id}_v2.pdf
└── templates/
    ├── classic.html
    ├── modern.html
    ├── warehouse.html
    ├── construction.html
    ├── food_service.html
    ├── medical_social.html
    └── styles/
        ├── classic.css
        ├── modern.css
        └── warehouse.css
```

### **PDF Generation Process**
```python
from weasyprint import HTML, CSS
from jinja2 import Template

class ResumeRenderer:
    def __init__(self):
        self.template_dir = 'templates/resume/'
        self.output_dir = 'static/resumes/'
    
    async def generate_resume_pdf(self, resume_id):
        """
        Generate PDF and update employment.db with file path
        """
        # Get resume data from employment.db
        resume = await get_resume_from_employment_db(resume_id)
        client = await get_client_from_core_db(resume.client_id)
        
        # Load template
        template_path = f"{self.template_dir}{resume.template_type}.html"
        with open(template_path, 'r') as f:
            template = Template(f.read())
        
        # Render HTML with client + resume data
        html_content = template.render(
            client=client,
            resume_data=json.loads(resume.content),
            generated_date=datetime.now().strftime('%B %Y')
        )
        
        # Generate PDF
        client_dir = f"{self.output_dir}client_{resume.client_id}/"
        os.makedirs(client_dir, exist_ok=True)
        
        pdf_filename = f"resume_{resume_id}.pdf"
        pdf_path = f"{client_dir}{pdf_filename}"
        
        HTML(string=html_content).write_pdf(
            pdf_path,
            stylesheets=[CSS(f"{self.template_dir}styles/{resume.template_type}.css")]
        )
        
        # Update employment.db with PDF path
        await update_resume_pdf_path(resume_id, pdf_path)
        
        return pdf_path
```

---

## Testing Requirements

### **Database Integration Tests**

#### **1. Core Database Operations**
```python
def test_client_selection():
    """Test reading clients from core_clients.db"""
    clients = await get_available_clients()
    assert len(clients) > 0
    assert all('client_id' in client for client in clients)

def test_employment_profile_crud():
    """Test employment profile operations in employment.db"""
    # Create profile
    profile_data = create_test_employment_profile()
    profile = await create_employment_profile(profile_data)
    assert profile.profile_id is not None
    
    # Read profile
    retrieved = await get_employment_profile(profile.client_id)
    assert retrieved.profile_id == profile.profile_id
    
    # Update profile
    updated_data = {'career_objective': 'Updated objective'}
    await update_employment_profile(profile.profile_id, updated_data)
    
    # Verify update
    updated = await get_employment_profile(profile.client_id)
    assert updated.career_objective == 'Updated objective'

def test_resume_creation():
    """Test resume creation and storage"""
    resume_data = create_test_resume_data()
    resume = await create_resume(resume_data)
    
    assert resume.resume_id is not None
    assert resume.client_id == resume_data['client_id']
    assert resume.template_type == resume_data['template_type']
    
    # Verify storage in employment.db
    stored = await get_resume_by_id(resume.resume_id)
    assert stored is not None
```

#### **2. Cross-Database Relationships**
```python
def test_client_resume_relationship():
    """Test foreign key relationship between core_clients and employment"""
    # Get client from core_clients.db
    client = await get_test_client()
    
    # Create resume in employment.db
    resume = await create_resume({'client_id': client.client_id, 'template_type': 'modern'})
    
    # Verify relationship
    client_resumes = await get_resumes_by_client(client.client_id)
    assert len(client_resumes) >= 1
    assert any(r.resume_id == resume.resume_id for r in client_resumes)

def test_job_application_integration():
    """Test resume-to-job application linking"""
    resume = await create_test_resume()
    
    application_data = {
        'client_id': resume.client_id,
        'resume_id': resume.resume_id,
        'job_title': 'Test Job',
        'company_name': 'Test Company'
    }
    
    application = await create_job_application(application_data)
    assert application.resume_id == resume.resume_id
    
    # Verify reverse lookup
    resume_applications = await get_applications_by_resume(resume.resume_id)
    assert len(resume_applications) >= 1
```

### **API Endpoint Tests**

#### **3. Resume API Endpoints**
```python
def test_create_resume_endpoint():
    """Test POST /api/resume/create"""
    client = await create_test_client()
    
    resume_data = {
        'client_id': client.client_id,
        'template_type': 'modern',
        'resume_title': 'Test Resume'
    }
    
    response = await client.post('/api/resume/create', json=resume_data)
    assert response.status_code == 201
    
    data = response.json()
    assert data['success'] is True
    assert 'resume_id' in data
    assert 'ats_score' in data

def test_get_client_resumes_endpoint():
    """Test GET /api/resume/list/{client_id}"""
    client = await create_test_client()
    resume = await create_test_resume(client.client_id)
    
    response = await client.get(f'/api/resume/list/{client.client_id}')
    assert response.status_code == 200
    
    data = response.json()
    assert data['success'] is True
    assert len(data['resumes']) >= 1
    assert any(r['resume_id'] == resume.resume_id for r in data['resumes'])
```

### **AI Integration Tests**

#### **4. AI Optimization Tests**
```python
def test_ats_scoring():
    """Test ATS score calculation"""
    resume_content = create_test_resume_content()
    score = calculate_ats_score(resume_content)
    
    assert 0 <= score <= 100
    assert isinstance(score, (int, float))

def test_resume_optimization():
    """Test AI-powered resume optimization"""
    resume = await create_test_resume()
    job_description = "Looking for experienced warehouse worker with forklift certification"
    
    optimized = await optimize_resume_for_job(resume.resume_id, job_description)
    assert optimized is not None
    assert 'career_objective' in optimized
    
    # Verify tailoring record saved
    tailoring = await get_resume_tailoring(resume.resume_id)
    assert tailoring is not None
```

### **File Operations Tests**

#### **5. PDF Generation Tests**
```python
def test_pdf_generation():
    """Test PDF creation and file storage"""
    resume = await create_test_resume()
    
    pdf_path = await generate_resume_pdf(resume.resume_id)
    assert pdf_path is not None
    assert os.path.exists(pdf_path)
    
    # Verify PDF path stored in database
    updated_resume = await get_resume_by_id(resume.resume_id)
    assert updated_resume.pdf_path == pdf_path

def test_pdf_download():
    """Test PDF download endpoint"""
    resume = await create_test_resume()
    await generate_resume_pdf(resume.resume_id)
    
    response = await client.get(f'/api/resume/download/{resume.resume_id}')
    assert response.status_code == 200
    assert response.headers['content-type'] == 'application/pdf'
```

---

## Success Criteria & Rebuild Checklist

### **Core Functionality (MUST WORK)**
- ✅ **Client Selection**: Displays clients from core_clients.db
- ✅ **Employment Profile**: Creates and updates profiles in employment.db
- ✅ **Resume Creation**: Generates resumes from profiles with templates
- ✅ **PDF Generation**: Creates downloadable PDF files
- ✅ **Resume Management**: Lists and manages existing resumes
- ✅ **Job Applications**: Links resumes to job applications

### **Integration Points (MUST WORK)**
- ✅ **Database Relations**: Proper foreign keys between core_clients.db and employment.db
- ✅ **Cross-Module Access**: Reminders and AI can read employment data
- ✅ **Client Data Flow**: Auto-populates from core client information

### **Advanced Features (NICE TO HAVE)**
- ✅ **AI Optimization**: OpenAI integration for content improvement
- ✅ **ATS Scoring**: Automatic scoring algorithm
- ✅ **Template Variety**: All 6 templates working correctly
- ✅ **Application Tracking**: Full job application workflow

### **Performance & Quality (MUST WORK)**
- ✅ **Error Handling**: Graceful failure modes
- ✅ **Data Validation**: Input validation on all forms
- ✅ **File Management**: Proper PDF storage and cleanup
- ✅ **Response Times**: Reasonable API response times

This corrected specification aligns perfectly with your 9-database architecture, providing a clean and maintainable Resume Builder that integrates seamlessly with the rest of your Case Management Suite!